# Vtonaxシステム設計と実装

[中文](WIKI.md) | [English](WIKI_EN.md) | [日本語](WIKI_JA.md)

## 1. はじめに

Vtonaxシステムは、Androidプラットフォーム向けの拡張現実アプリケーションプロジェクトです。本システムのコア目標は、モバイルデバイス上で効率的なリアルタイムカメラトラッキングとスパースマッピング機能を実現することです。具体的には、単眼ORB-SLAM2ベースの同時位置推定とマッピング、安定した平面検出とARオブジェクト配置、永続化可能なマップ管理、およびオプションの軽量物体検出機能(ncnnフレームワークのYOLOv5アルゴリズムベース)が含まれます。システム設計は、モバイルデバイスのハードウェア特性を十分に考慮し、リアルタイム性、安定性、使いやすさの間で良好なバランスを実現しています。

## 2. システムアーキテクチャ

本システムは階層アーキテクチャ設計を採用し、主に以下のコアコンポーネントを含みます:

### アプリケーション層(Android)
カメラドライバー、ユーザーインターフェースコントロール、レンダリング制御、ユーザーインタラクション、およびネイティブライブラリ(JNI)との双方向通信を担当します。

### ネイティブ層(C++)
改造されたORB-SLAM2ベースのコアアルゴリズム(トラッキング、ローカルマッピング、ループクロージャ、マップ管理モジュールを含む)、DBoW2 Bag-of-Wordsモデル、g2o最適化フレームワーク、YOLOv5推論エンジン(ncnnフレームワークベース)、および複数のユーティリティモジュール(行列演算、点群レンダリング、リソース読み込み、平面検出など)を統合しています。

### リソース管理層
システムのコア依存リソース(カメラ設定、Bag-of-Wordsモデル、検出モデルパラメータなど)は、ビルド段階でネイティブライブラリに埋め込まれ、実行時にメモリから直接読み込まれるため、外部ファイル依存とパス設定の複雑さを効果的に削減します。

### レンダリング層
「背景カメラフレーム層」と「前景ARオブジェクト層」を重ね合わせて構成され、それぞれリアルタイム性と視覚的な明瞭性を確保します。

## 3. システム動作フロー

本システムの典型的な動作フローは以下の通りです:

1. アプリケーションが起動し、必要なシステム権限(カメラ、ストレージなど)を要求します。

2. リアカメラを開き、画像フレームを連続的に取得し、システム処理に必要な形式(グレースケールとカラー画像)に変換します。

3. JNIインターフェースを通じて画像フレームをネイティブ層に渡します:SLAMトラッキングとマッピングタスクを実行し、物体検出が有効な場合は非同期推論を実行し、カメラポーズ、キーポイント、マップポイント、アライメントステータスなどのコアデータを維持します。

4. レンダリング層処理:背景層がリアルタイムカメラフレームを描画し、レンダリング条件が満たされている場合(トラッキングステータスが正常、平面検出が有効、アライメント戦略が満たされている)、前景層がARオブジェクトを描画します。

5. マップ管理:ユーザーはいつでもマップを保存またはロードでき、セッション間の再ローカライゼーションとシーン復元機能を実装します。

## 4. システム機能特性

本システムは以下のコア機能特性を備えています:

### リアルタイム単眼SLAM
カメラポーズ推定、ローカルマッピング、ループ検出、グラフ最適化などのコア機能を実装します。

### 平面検出とAR配置
利用可能なポーズとマップポイントに基づいて平面パラメータを推定し、ARオブジェクトの配置と座標アライメントに使用します。

### ARレンダリング
モデル、ビュー、プロジェクション行列に基づいて3Dオブジェクトを描画し、ジェスチャースケーリングと基本的なポーズ補正をサポートします。

### マップの永続化
キーフレームとマップポイントの主要情報をカスタムバイナリ形式で保存し、セッション間の再ローカライゼーションをサポートします。

### 物体検出(オプション)
ncnnフレームワークベースのYOLOv5検出アルゴリズムで、非同期とダウンサンプリング戦略を使用してパフォーマンスをバランスします。

### 点群可視化
グローバルマップポイントと現在のトラッキングキーポイントを表示し、トラッキングとアライメント品質の観察を容易にします。

### 信頼性の強化
長時間のトラッキング損失後に「軽量リセット」を実行し、マップデータを保持して復旧を加速します。

### SLAMスイッチ
実行時にSLAM機能を有効/無効にできます。無効にすると、ポーズ更新とARレンダリング判定が停止します。

### マップ統計表示
定期的にキーフレーム数、マップポイント数、平面存在状態を表示し、マッピングと安定性の観察を容易にします。

## 5. コアアルゴリズム実装

### 5.1 SLAMシステム協調メカニズム

SLAMシステムはマルチスレッド協調メカニズムを採用し、モジュール間の効率的な協調作業を確保します。

#### Bag-of-Wordsとキーフレームデータベース
システムは事前トレーニングされたBag-of-Wordsモデルをロードし、場所認識と再ローカライゼーションをサポートします。キーフレームデータベースは類似フレームの高速検索に使用され、マッチング効率を向上させます。

#### マップデータ構造
システムは統一されたデータ構造を採用してキーフレームとマップポイントを管理し、統計、挿入/削除、取得操作をサポートします。

#### 3スレッド協調モデル

- **トラッキングスレッド**:各画像フレームのポーズ推定を実行し、必要に応じて新しいキーフレームを作成します。
- **ローカルマッピングスレッド**:ローカルマップを維持・最適化し、マップ品質を確保します。
- **ループクロージャスレッド**:ループを識別してグラフ最適化を実行し、累積ドリフトを効果的に抑制します。

#### モード切り替えメカニズム
システムは「ローカライゼーションのみモード」への移行をサポートし、マッピングを一時停止して安定性を向上させます。特に既存のマップをロードした後の純粋なローカライゼーションシナリオに適しています。

### 5.2 トラッキングとアライメント戦略

#### ポーズ推定
特徴マッチングと最適化アルゴリズムを通じて現在のカメラポーズを取得します。リアルタイム性のため、システムは入力側で適切なダウンサンプリング戦略を採用します。

#### マップアライメント
履歴マップがロードされた場合、システムは現在のSLAM座標系をロードされたマップの座標系とアライメントする必要があります。アライメント成功後:

- グローバル点群はアライメントされたポーズで投影され、安定した視覚参照を提供します
- ARレンダリングはアライメントされたビュー行列を使用し、同じ座標系内のオブジェクトと点群の一貫性を確保します

#### レンダリング前提条件
「トラッキングステータスが正常 + 平面検出が有効 + アライメント条件が満たされている(平面ソースに依存)」場合にのみARオブジェクトを描画します。

### 5.3 平面検出とAR行列計算

#### 平面ソース分類

- **オンサイト検出**:現在のポーズと近隣マップポイントに基づいて平面パラメータを推定します
- **マップ復元**:保存されたAR補助情報から平面パラメータを復元します(マップアライメント関係に注意が必要)

#### 行列生成メカニズム

- **モデル行列**:平面に対するARオブジェクトの配置とポーズを記述します
- **ビュー行列**:(必要に応じてアライメントされた)カメラポーズに基づいて計算されます
- **プロジェクション行列**:カメラ内部パラメータと出力サイズから導出され、トラッキング解像度との一貫した関係を維持する必要があります

#### 更新戦略
平面が検出されたとき、またはマップから復元されたときに、システムはモデル行列とプロジェクション行列を即座に更新します。アライメントステータスが変化したときは、ビュー行列を更新します。

### 5.4 マップ永続化メカニズム

#### マップ保存目標
システムは、キーフレームのポーズと特徴情報、マップポイントの幾何学的情報とディスクリプタ情報をカスタムバイナリ形式で保存し、セッション間の再ローカライゼーションを実装します。

#### マップロードプロセス

1. **ロード前のクリーンアップ**:メモリ内の残留マップコンテンツをクリアし、クリーンな座標系環境を確保します
2. **属性復元**:マップポイントの主要属性を復元し、誤削除を防ぐために適切な可視性統計を設定します
3. **キャッシュ再構築**:トラッカー参照キャッシュを再構築し、後続の再ローカライゼーションの成功率と速度を向上させます
4. **モード復元**:通常のSLAMモードを復元し、マップの改良または拡張を継続します

#### ユーザーエクスペリエンス目標
ロード後、オンサイトで素早くアライメントを完了し、緑色の点群とARオブジェクトが履歴シーン関係に従って表示されます。

### 5.5 物体検出メカニズム(YOLOv5)

#### 動作目的
ARフレームに検出結果を重ねることで、シーン理解とデモ効果を向上させます。

#### パフォーマンス最適化戦略

- **スレッド分離**:別のスレッドを使用して推論タスクを実行し、レンダリングとSLAMメインスレッドのブロッキングを回避します
- **ダウンサンプリング処理**:ダウンサンプリングされた入力を使用して推論遅延を削減します
- **結果最適化**:結果を元の解像度にスケールバックし、新しい結果がない場合は最後の結果を維持してちらつきを回避します

#### 互換性戦略
システムは、デバイスサポート条件が良好な場合(グラフィック機能、メモリとCPUコア、システムバージョン)にのみ物体検出を有効にし、低性能デバイスではデフォルトでこの機能を非表示または無効にします。

### 5.6 レンダリング層とインタラクション設計

#### 背景フレームレンダリング
フルスクリーン正投影モードでリアルタイムカメラフレームを描画し、スムーズさと低遅延を優先します。

#### 前景ARオブジェクトレンダリング

- **条件付き描画**:レンダリング条件が満たされている場合に描画します
- **ジェスチャーインタラクション**:固定ポーズ補正付きのジェスチャースケーリングをサポートし、より自然な表示を実現します
- **座標一貫性**:点群表示と同じ座標系を共有し、視覚的一貫性を確保します

#### 点群表示メカニズム

- **グローバルポイント表示**:アライメント後に表示されるグローバルポイントは空間参照を提供します
- **トラッキングキーポイント表示**:トラッキングキーポイントは現在のフレームマッチング品質を反映し、システムステータスの観察を容易にします

#### インタラクション補完メカニズム
ARオブジェクトスケーリングは累積スケーリング方式を採用し、最小/最大境界を設定して歪みを回避します。タップによるカメラオートフォーカストリガーをサポートし、トラッキング品質を向上させます。

### 5.7 スレッドモデルとパフォーマンス最適化

- **トラッキングスレッド**:高優先度と高頻度で実行し、必要に応じて入力をダウンサンプリングしてスループットを向上させます
- **ローカルマッピングとループクロージャスレッド**:バックグラウンドでマップ品質を維持し、ドリフトエラーを修正します
- **物体検出スレッド**:条件トリガーと待機メカニズムを使用して、ビジーウェイトとリソース競合を削減します
- **レンダリングスレッド**:ユーザーインターフェースのスムーズさを維持し、メインスレッドでの重い計算を回避し、初期化などの重要な操作をシーケンシャルにスケジュールして引っかかりを減らします

### 5.8 トラッキングパイプライン詳細

#### 特徴抽出
現在のフレームで頑健なコーナーポイントを抽出し、コンパクトなディスクリプタを生成して、フレーム間およびマップ-フレーム間のマッチング関係を確立します。

#### 初期マッチング
前のフレームまたはローカル参照キーフレームとのマッチング関係を優先的に確立し、初期値を素早く提供します。

#### モーションモデルと事前情報
前のフレームのポーズと単純なモーション仮定を組み合わせて初期ポーズ予測を提供し、最適化収束速度を向上させます。

#### 幾何学的一貫性制約
投影幾何学、スケール、観測可視性制約を通じて誤ったマッチングをフィルタリングし、ポーズを頑健に推定します。

#### ポーズ最適化
再投影誤差を目的とする非線形最適化で、外れ値を除去した後、現在のフレームポーズと有効な観測セットを出力します。

#### キーフレーム判定
視差、観測カバレッジ、トラッキング品質などのメトリックに基づいて、新しいキーフレームを挿入するかどうかを決定し、マップ密度とトラッキング安定性を維持します。

### 5.9 ローカルマッピングのコア責務

#### マップポイント生成と融合
新しいキーフレームの視差と三角測量を利用して新しいマップポイントを生成し、隣接キーフレームの重複ポイントと融合して冗長性を抑制します。

#### ローカル最適化
現在のローカルマップ(現在のキーフレーム、共視キーフレーム、関連マップポイント)に対してローカルバンドル調整を実行し、幾何学的一貫性を向上させます。

#### マップポイントカリング
可視性率、マッチング成功率、観測角度などのメトリックに基づいて不安定なポイントを削除し、マップの「洗練された安定した」特性を維持します。

### 5.10 ループ検出とグローバル一貫性最適化

#### ループ候補検索
Bag-of-Wordsモデルに基づいてキーフレームデータベース内で類似候補を検索し、類似性を予備評価します。

#### ループ検証
幾何学的一貫性とポーズ関係を通じて候補を検証し、純粋な外観エラーによる誤マッチングを回避します。

#### グラフ最適化
ループ制約を導入した後、ポーズグラフ最適化と必要なグローバルバンドル調整を実行し、ドリフトをグローバルに抑制し、一貫した座標系を再構築します。

### 5.11 マップアライメントメカニズム

#### トリガー条件
履歴マップがロードされた場合、システムは現在のSLAM座標系をそのマップの座標系にマッピングしようとします。

#### アライメント入力
現在のフレームまたは短時間ウィンドウ内の観測と、ロードされたマップ内の既知の構造(キーフレーム/マップポイント)との対応関係。

#### 解決目標
剛体変換パラメータのセットを推定し、ロードされたマップ座標系での現在の観測の投影誤差を最小化します。

#### 使用方法

- アライメントが成功すると、レンダリングと点群表示の両方がアライメントされたカメラポーズを使用します
- アライメントが失敗した場合、信頼度閾値が満たされるまで試行を続けます

### 5.12 平面検出アルゴリズム

#### 入力ソース
現在のポーズ近くのスパースマップポイントとその空間分布。

#### モデル仮定
一群のポイントの空間位置を説明できる局所近似平面が存在します。

#### 推定プロセス
頑健な推定方法を通じて3D点セット内で最大一致セットの平面をフィッティングし、法線ベクトルと参照点を計算します。

#### 安定性戦略
マップが大幅に変更されたとき、またはトラッキングステータスが変動したときは、より安定した平面パラメータを取得するために推定を遅延または繰り返します。

### 5.13 AR行列計算と一貫性保証

#### モデル行列
「オブジェクトローカル座標」を「平面/ワールド座標」に変換し、位置、向き、スケーリング関係を体現します。

#### ビュー行列
「ワールド座標」を「カメラ座標」に変換し、現在のカメラポーズ(優先的にアライメントされたポーズを使用)によって決定されます。

#### プロジェクション行列
「カメラ座標」を「スクリーン座標」に投影し、内部パラメータとビューポートパラメータから構築され、処理解像度との一貫した関係を要求します。

#### 一貫性ポイント
点群、ARオブジェクト、カメラフレームは同じ座標変換チェーンに基づいている必要があり、任意のステップでの座標系選択の不一致は位置ずれを引き起こします。

### 5.14 YOLO非同期処理メカニズム

#### プロデューサー-コンシューマーモデル
レンダリング/SLAMスレッドがリズムに従ってダウンサンプリングされた画像を送信し、検出スレッドは新しいタスクが到着したときに推論を実行するためにウェイクアップします。

#### 同期と共有メカニズム
セマフォ/条件変数を使用してビジーウェイトを回避し、タイムスタンプ付きの検出結果を共有し、レンダリング側は必要に応じて取得します。

#### 結果安定性保証
新しい結果が利用できない場合は古い結果を再利用して検出ボックスのちらつきを回避します。必要に応じて結果の有効期限ポリシーを設定して時効性をバランスさせることができます。

#### リソース制御戦略
デバイス能力が不十分な場合は検出を無効にするか、入力サイズと検出頻度を適切に削減してSLAMへの干渉を減らします。

### 5.15 システム障害処理と復旧メカニズム

#### 短期トラッキング障害
モーションモデルとローカルマッチングを通じて迅速な復旧を試みます。復旧に失敗した場合は、「ロスト」状態のタイミングに入ります。

#### ロストタイムアウト処理
「軽量リセット」を実行し、トラッキングステータスのみをクリアしてマップを保持し、その後、ロードされたマップに基づいて再ローカライゼーションを試行し続けます。

#### アライメント不安定処理
アライメント信頼度が不十分な場合は、ARレンダリングにアライメントされたポーズを使用せず、視覚的な位置ずれを回避します。閾値が満たされるまで観測を蓄積し続けます。

#### 平面不安定処理
マップが明らかに更新されたとき、または観測が不十分なときは平面更新を延期し、ステータスが安定した後にARモデル行列を更新します。

## 6. システム信頼性とフォールトトレランス設計

### ロスト復旧メカニズム
システムが長時間ロスト状態にある場合、「軽量リセット」操作を実行し、トラッキングステータスのみをクリアしてロードされたマップを保持し、より高速な復旧を可能にします。

### 平面一貫性保証

- 「マップから復元された平面」については、マップアライメントに厳密に依存します
- 「オンサイト検出された平面」については、アライメント前でも使用できますが、アライメントされたロジックには影響しません

### マップ安全性保証
ロードされたマップのスケールに対して適切な境界チェックを実行し、メモリ圧迫やシステム不安定を回避します。

### レンダリングフォールトトレランスメカニズム
システムステータスまたは行列が要件を満たさない場合はARオブジェクトを描画せず、画面のちらつきと位置ずれを回避します。

### リセット詳細処理
「軽量リセット」を実行するときは、ロードされたマップとマップから復元された平面を保持し、手動で検出された平面と一時的なARステータスのみをクリアして、視覚的な突然変異を減らします。

## 7. システム構成とリソース管理

### リソース埋め込みメカニズム
カメラ設定、Bag-of-Words、検出モデルなどは、バイナリ形式でネイティブライブラリにパッケージ化され、実行時にメモリマッピングを介して読み込まれ、パスと権限の問題を回避します。

### カメラ内部パラメータ設定
プロジェクション行列の導出に使用され、画像処理解像度との一貫した関係を維持する必要があります。

### デジタル透かし機能
スイッチを通じてオーバーレイするかどうかを制御し、フレームサイズに応じた適応スケーリングと透明合成をサポートします。

## 8. システム使用境界と前提条件

### 照明、テクスチャ、モーション条件
良好なテクスチャと安定したカメラモーションはトラッキング安定性を大幅に向上させることができます。過度のモーションブラーまたは繰り返しテクスチャは効果を低下させます。

### デバイスパフォーマンス要件
メモリ、CPUコア、グラフィック機能、システムバージョンは、リアルタイム性とオプション機能(物体検出など)が有効になるかどうかに大きく影響します。

### データセキュリティ要件
永続化されたマップと補助情報はローカルファイルであり、プラットフォーム権限とユーザーデータセキュリティ要件に準拠する必要があります。

## 9. 用語解説

- **ポーズ**:空間内のカメラの位置と向き。
- **キーフレーム**:時系列から選択された代表的なフレームで、マップ構築と最適化に使用されます。
- **マップポイント**:3D空間内のスパース特徴点の集合。
- **アライメント**:現在のSLAM座標系とロードされたマップの座標系との間に安定した一貫した関係を確立すること。
- **プロジェクション行列**:カメラ内部パラメータとビューポートパラメータから計算され、3D点をスクリーン平面に変換するために使用されます。

## 10. 結論

Vtonax_SLAMシステムは、モバイルデバイス上で単眼SLAM、平面検出、ARレンダリング、オプションの物体検出機能を統合しています。明確なレンダリング条件とアライメント戦略、リソース埋め込みとスレッド並列メカニズム、軽量リセットと参照キャッシュ再構築などの信頼性設計を通じて、本システムは通常のモバイルデバイス上でリアルタイム性と安定性の良好なバランスを達成し、AR配置、屋内視覚ローカライゼーション、軽量知覚融合などのアプリケーションシナリオに適しています。

## 13. 数学と最適化の要点

### 13.1 カメラモデルと投影変換

#### カメラ内部パラメータ行列
焦点距離(fx, fy)と主点(cx, cy)パラメータを含み、3D空間点を2Dピクセル座標に投影するために使用されます。

#### ワールド座標系からカメラ座標系への変換
回転行列Rと並進ベクトルtを通じてワールド点Xwをカメラ座標Xcに変換します。

#### 投影プロセス
最初にカメラ座標を正規化(Xc/Zc, Yc/Zc)し、次に内部パラメータ行列を通じてピクセル座標系にマッピングします。

#### 単眼スケール不確実性
単眼カメラは深度情報が不足しているため、キーフレームグラフ最適化とループクロージャ検出を通じてスケールドリフト問題を解決する必要があります。

### 13.2 再投影誤差とロバスト最適化

#### 再投影残差計算
観測値と予測投影値との差で、ポーズ推定の精度を測定するために使用されます。

#### 最適化目的関数
すべての観測点の再投影誤差の加重和を最小化し、ロバスト損失関数を使用して外れ値の影響を減らします。

#### ポーズ最適化方法

- **PNPアルゴリズム**:既知の3D点と対応する2D投影が与えられた場合にカメラポーズを解決します
- **LMアルゴリズム**:ダンピング戦略を使用して非線形最適化の安定性を向上させます
- **BA最適化**:カメラポーズと3D点座標を同時に最適化して、グローバル最適解を取得します

### 13.3 キーフレーム挿入とローカルバンドル調整

#### キーフレーム挿入基準

- **視差閾値**:現在のフレームと参照キーフレームの間には十分な視差が必要です
- **カバレッジ**:新しいフレームは十分な数のローカルマップポイントを観測する必要があります
- **トラッキングインライア率**:トラッキング品質は最小要件を満たす必要があります

#### ローカルバンドル調整(ローカルBA)

- **最適化範囲**:現在のキーフレーム、共視キーフレーム、関連マップポイントで構成されるサブグラフ
- **最適化目標**:サブグラフ内のすべての再投影誤差を最小化します
- **解決戦略**:スパース増分解法を使用して計算効率と精度のバランスを取ります

### 13.4 ループクロージャ検出とポーズグラフ最適化

#### ループクロージャ検出フロー

- **候補検索**:Bag-of-Wordsモデルに基づいてキーフレームデータベース内で類似キーフレームを検索します
- **幾何学的検証**:幾何学的一貫性チェックを通じて真のループクロージャ関係を確認します
- **制約追加**:ループクロージャ制約をポーズグラフ構造に追加します

#### ポーズグラフ最適化

- **最適化目標**:すべてのポーズ間の相対変換の誤差を最小化します
- **情報行列**:各エッジ測定の信頼度を表します
- **最適化後処理**:グローバルBAをアタッチしてマップ品質をさらに最適化できます

### 13.5 セッション間マップアライメント

#### アライメントトリガー条件
履歴マップをロードした後、現在のSLAM座標系をロードされたマップの座標系とアライメントする必要があります。

#### アライメントアルゴリズムの原理

- **入力データ**:現在の観測とロードされたマップ内の既知の構造との対応関係
- **最適化目標**:対応する点の目標座標系での投影誤差を最小化する最適類似変換を見つけます
- **解決方法**:直交プロクラステス問題またはUmeyamaアルゴリズムを使用し、回転、並進、スケール変換を含みます

#### アライメント結果の適用

- **アライメント成功後**、レンダリングと点群表示の両方がアライメントされた座標系を使用します
- **アライメント失敗時**、信頼度閾値が満たされるまで試行を続けます

### 13.6 平面推定方法

#### 平面表現
法線ベクトルnと平面から原点までの距離dを使用して平面を表現し、制約条件||n||=1を満たします。

#### 平面フィッティングアルゴリズム

- **RANSACアルゴリズム**:最小点セットのランダムサンプリングを通じて平面モデルを推定します
- **インライア選択**:直交距離閾値に基づいて平面モデルに適合する点をフィルタリングします
- **最適化プロセス**:インライアセットの直交距離の二乗和を最小化して最適な平面パラメータを取得します

#### 平面パラメータ計算

- **法線ベクトル計算**:共分散行列の固有値分解を通じて、法線ベクトルは最小固有値の固有ベクトルに対応します
- **距離計算**:法線ベクトルと平面中心点を通じて平面から原点までの距離を計算します

### 13.7 プロジェクション/ビュー/モデル行列と座標系変換

#### モデル行列
オブジェクトローカル座標からワールド座標への変換を記述し、回転、並進、スケーリングを含みます。

#### ビュー行列
ワールド座標をカメラ座標に変換し、現在のカメラポーズに基づいて計算されます。

#### プロジェクション行列
カメラ座標をスクリーン座標にマッピングし、カメラ内部パラメータとビューポートパラメータから構築されます。

#### 座標一貫性要件
点群表示、ARオブジェクトレンダリング、カメラフレームは同じ座標変換チェーンを使用する必要があり、視覚的一貫性を確保します。

### 13.8 物体検出のマルチスレッド推論モデリング

#### 検出関数モデル
入力画像をオブジェクトセット(カテゴリ、信頼度、バウンディングボックス)にマッピングします。

#### マルチスレッドアーキテクチャ

- **プロデューサー**:レンダリング/SLAMスレッドが固定ビートでダウンサンプリングされた画像を送信します
- **コンシューマー**:検出スレッドは新しいタスクが到着したときに推論計算を実行します
- **同期メカニズム**:セマフォと条件変数を使用してビジーウェイトを回避し、スレッド間の効率的な協調を確保します

#### 結果処理戦略

- **安定性保証**:新しい結果が利用できない場合は最後の検出結果を再利用し、検出ボックスのちらつきを回避します
- **スケールマッピング**:検出結果をダウンサンプリングされた画像スケールから元の画像スケールにマッピングします

### 13.9 システム障害と復旧メカニズム

#### 状態定義
システムには初期化されていない、トラッキング正常、ロストの3つの状態が含まれます。

#### 復旧メカニズム

- **短期障害**:モーションモデルとローカルマッチングを通じて迅速な復旧を試みます
- **長期ロスト**:閾値時間後に軽量リセットを実行し、トラッキングステータスのみをクリアしてマップを保持します
- **再ローカライゼーション**:ロードされたマップに基づいて再ローカライゼーションマッチングを実行します

### 13.10 リー群パラメータ化と増分更新

#### ポーズパラメータ化
リー群SE(3)または類似変換群Sim(3)を使用してカメラポーズを表現します。

#### 最適化プロセス

- **リー代数表現**:リー代数空間で最適化計算を実行します
- **指数写像**:リー代数増分の指数写像を通じてポーズを更新します

#### 線形化処理

- **残差近似**:一次テイラー展開を通じて残差関数を近似します
- **正規方程式**:線形化結果に基づいて正規方程式を構築して解決します

### 13.11 正規方程式とシュール補完

#### 加重最小二乗
異なる観測の信頼度の違いを処理するために加重正規方程式を構築します。

#### シュール補完法

- **行列分割**:ヘッシアン行列をポーズと構造の部分に分割します
- **消去プロセス**:構造変数を消去してシステム次元を削減します
- **解決順序**:最初にポーズ増分を解決し、次に後退代入で構造増分を解決します

#### 最適化効果
線形システムのスケールを大幅に削減し、解決効率を向上させます。

### 13.12 ロバストM推定とカーネル関数

#### ロバスト損失関数

- **重み関数**:重み関数を通じてロバスト損失を実装し、外れ値の影響を減らします
- **Huberカーネル関数**:小さい残差には二次成長、大きい残差には線形成長を使用します

#### 反復再加重

- **IRLSアルゴリズム**:各反復で現在の残差に基づいて重み行列を更新します
- **収束性**:最適化問題が収束するまで反復を繰り返します

### 13.13 RANSACインライアセットとロバスト幾何学的推定

#### RANSACアルゴリズムフロー

- **ランダムサンプリング**:最小点セットをランダムに選択して幾何学的モデルを推定します
- **インライア評価**:コスト関数を通じてすべての点のインライア属性を評価します
- **モデル選択**:最も多くのインライアまたは最小コストを持つモデルを選択します

#### 精緻化最適化

- **加重最適化**:フィルタリングされたインライアセットに対して加重精緻化最適化を実行します
- **精度保証**:アルゴリズムのロバスト性と推定精度のバランスを取ります

### 13.14 類似変換(Sim(3))閉形式推定

#### 最適化目標
対応する点対の誤差を最小化する最適類似変換(回転、並進、スケールを含む)を見つけます。

#### 解決プロセス

- **脱平均処理**:点セットに対して脱平均前処理を実行します
- **共分散計算**:点セット間の共分散行列を計算します
- **SVD分解**:特異値分解を通じて最適回転行列を解決します
- **パラメータ計算**:スケール係数と並進ベクトルを順次計算します

#### 退化処理
共線または共平面などの退化ケースに対して条件数とランクをチェックして解決の安定性を確保します。

### 13.15 制約条件、ゲージ処理、境界処理

#### 単眼システム制約

- **ゲージ自由度**:単眼SLAMにはスケールと全体的なポーズのゲージ自由度が存在します
- **制約方法**:最初のフレームを固定するか、事前制約を追加してヌル空間を排除します

#### マップアライメント処理

- **座標アンカリング**:マップロードアライメント後、目標座標系をアンカーとして一貫性を維持します
- **グラフ最適化**:グラフ最適化でアンカーノードに強い事前または固定処理を適用します

### 13.16 数値安定性と収束性分析

#### 安定性戦略

- **ダンピング方法**:LMなどのダンピング戦略を採用して、高度に非線形な領域での安定性を向上させます
- **初期値選択**:モーションモデルまたはローカルマッチングを利用して良好な初期値を提供し、収束を加速します

#### 退化識別

- **監視指標**:ヘッシアン行列の条件数、固有値スペクトル、インライア比率をチェックします
- **適応調整**:監視結果に基づいてキーフレーム挿入を延期するか、最適化パラメータを調整します

# Vtonax（维点域）系统设计与实现

[中文](WIKI.md) | [English](WIKI_EN.md) | [日本語](WIKI_JA.md)

## 1. 引言

Vtonax（维点域）系统是一个面向Android平台的增强现实应用工程。本系统的核心目标是在移动设备上实现高效的实时相机跟踪与稀疏建图功能，具体包括基于单目ORB-SLAM2的同步定位与地图构建、稳定的平面检测与AR物体放置、可持久化的地图管理，以及可选的轻量级目标检测能力（基于ncnn框架的YOLOv5算法）。系统设计充分考虑了移动设备的硬件特性，在实时性、稳定性和易用性之间实现了良好的平衡。

## 2. 系统架构

本系统采用分层架构设计，主要包括以下几个核心组件：

### 应用层（Android）
负责相机驱动、用户界面控件、渲染控制、用户交互以及与本地库（JNI）的双向通讯。

### 本地层（C++）
整合了基于ORB-SLAM2魔改后的核心算法（包括跟踪、局部建图、回环闭合、地图管理等模块）、DBoW2词袋模型、g2o优化框架、YOLOv5推理引擎（基于ncnn框架）以及若干工具模块（矩阵运算、点云绘制、资源读取、平面检测等）。

### 资源管理层
系统的核心依赖资源（包括相机配置、词袋模型、检测模型参数等）在构建阶段被嵌入到本地库内部，运行时直接从内存中读取，有效降低了外部文件依赖和路径配置复杂度。

### 渲染层
由"背景相机画面层"和"前景AR物体层"叠加组成，分别确保实时性与视觉清晰度。

## 3. 系统运行流程

本系统的典型运行流程如下：

1. 应用启动并申请必要的系统权限（相机、存储等）。

2. 打开后置相机，持续获取图像帧并转换为系统处理所需的格式（灰度图像与彩色图像）。

3. 通过JNI接口将图像帧传入本地层：执行SLAM跟踪与建图任务；如启用目标检测功能则进行异步推理；同时维护相机位姿、关键点、地图点和对齐状态等核心数据。

4. 渲染层处理：背景层绘制实时相机画面；若满足渲染条件（跟踪状态正常、平面检测有效、对齐策略满足要求），则前景层绘制AR物体。

5. 地图管理：用户可在任意时刻保存或加载地图，实现跨会话的重定位与场景恢复功能。

## 4. 系统功能特性

本系统具备以下核心功能特性：

### 实时单目SLAM
实现相机位姿估计、局部建图、回环检测与图优化等核心功能。

### 平面检测与AR放置
在可用的位姿与地图点基础上估计平面参数，用于AR物体的放置与坐标对齐。

### AR渲染
根据模型、视图、投影矩阵绘制三维物体，支持手势缩放与基础姿态校正。

### 地图持久化
以自定义二进制格式保存关键帧与地图点的关键信息，支持跨会话的重定位功能。

### 目标检测（可选）
基于ncnn框架的YOLOv5检测算法，采用异步与降采样策略平衡性能。

### 点云可视化
展示全图地图点与当前追踪关键点，便于观测跟踪与对齐质量。

### 可靠性增强
长时间跟踪丢失后执行"轻量重置"，保留地图数据以加速恢复。

### SLAM开关
可在运行时启用/禁用SLAM功能；禁用后将停止位姿更新与AR渲染判定。

### 地图统计显示
定时展示关键帧数、地图点数与平面存在状态，便于观察构图与稳定性。

## 5. 核心算法实现

### 5.1 SLAM系统协调机制

SLAM系统采用多线程协调机制，确保各模块高效协同工作。

#### 词袋与关键帧数据库
系统加载预训练词袋模型以支持位置识别与重定位功能；关键帧数据库用于快速检索相似帧，提高匹配效率。

#### 地图数据结构
系统采用统一的数据结构管理关键帧与地图点，支持统计、增删和获取等操作。

#### 三线程协作模型

- **跟踪线程**：对每帧图像进行位姿估计，必要时创建新关键帧。
- **局部建图线程**：维护并优化局部地图，保证地图质量。
- **回环闭合线程**：识别回环并进行图优化，有效抑制累计漂移。

#### 模式切换机制
系统支持进入"仅定位模式"，暂停建图以提高稳定性，特别适用于加载现有地图后进行纯定位的场景。

### 5.2 跟踪与对齐策略

#### 位姿估计
通过特征匹配与优化算法获取当前相机位姿；为提高实时性，系统在输入侧采用合理的降采样策略。

#### 地图对齐
当加载历史地图后，系统需要将当前SLAM坐标系与加载地图坐标系进行对齐。对齐成功后：

- 全图点云以对齐后的位姿进行投影，提供稳定的视觉参考；
- AR渲染使用对齐后的视图矩阵，保证物体与点云在同一坐标系中的一致性。

#### 渲染前提条件
仅在"跟踪状态正常 + 平面检测有效 + 对齐条件满足（取决于平面来源）"时绘制AR物体。

### 5.3 平面检测与AR矩阵计算

#### 平面来源分类

- **现场检测**：基于当前位姿与邻域地图点估计平面参数；
- **地图恢复**：从保存的AR附属信息中恢复平面参数（需关注与地图对齐关系）。

#### 矩阵生成机制

- **模型矩阵**：描述AR物体相对平面的摆放与姿态；
- **视图矩阵**：基于（必要时对齐后的）相机位姿计算得到；
- **投影矩阵**：由相机内参与输出尺寸派生，需与跟踪时的分辨率关系保持一致。

#### 刷新策略
当检测到平面或从地图恢复平面后，系统立即更新模型矩阵与投影矩阵；当对齐状态发生变化时，更新视图矩阵。

### 5.4 地图持久化机制

#### 地图保存目标
系统将关键帧的位姿与特征信息、地图点的几何与描述子信息保存为自定义二进制格式，以便实现跨会话的重定位功能。

#### 地图加载流程

1. **加载前清理**：清理内存中残留的地图内容，确保坐标系环境干净；
2. **属性恢复**：恢复地图点的关键属性并设置合理的可见性统计，防止被误删；
3. **缓存重建**：重建跟踪器的参考缓存，提高后续重定位的成功率与速度；
4. **模式恢复**：恢复正常SLAM模式，以继续完善或扩展地图。

#### 用户体验目标
加载后在现场快速完成对齐，绿色点云与AR物体按照历史场景关系进行显示。

### 5.5 目标检测机制（YOLOv5）

#### 运行目的
在AR画面中叠加检测结果，提升场景理解与演示效果。

#### 性能优化策略

- **线程隔离**：采用单独线程承载推理任务，避免阻塞渲染与SLAM主线程；
- **降采样处理**：采用降采样输入以削减推理时延；
- **结果优化**：将结果回放缩放到原始分辨率，并在无新结果时保持上次结果以避免闪烁现象。

#### 兼容性策略
系统在设备支持条件较好（图形能力、内存与CPU核心数、系统版本）时才启用目标检测功能，弱设备默认隐藏或禁用该功能。

### 5.6 渲染层与交互设计

#### 背景画面渲染
以全屏正交方式绘制实时相机画面，优先保证流畅性与低延迟。

#### 前景AR物体渲染

- **条件绘制**：在渲染条件满足时进行绘制；
- **手势交互**：支持手势缩放并附带固定姿态修正，以获得更自然的显示效果；
- **坐标一致性**：与点云显示共享同一坐标系，确保视觉一致性。

#### 点云显示机制

- **全图点显示**：对齐后展示的全图点提供空间参考；
- **追踪关键点显示**：追踪关键点反映当前帧匹配质量，便于观察系统状态。

#### 交互补充机制
AR物体缩放采用累计缩放方式，设定最小/最大边界以避免失真；支持点击触发相机自动对焦以提升跟踪质量。

### 5.7 线程模型与性能优化

- **跟踪线程**：采用高优先级与高频率运行，必要时对输入进行降采样以提升吞吐量。
- **局部建图与回环闭合线程**：在后台维护地图质量并纠正漂移误差。
- **目标检测线程**：采用条件触发与条件等待机制，减少忙等与资源争用。
- **渲染线程**：保持用户界面流畅性，避免在主线程执行重度计算，初始化等重要操作按时序安排以减少卡顿感。

### 5.8 跟踪流水线详解

#### 特征提取
在当前帧中提取鲁棒角点并生成紧凑描述子，用于建立帧间与图-帧间的匹配关系。

#### 初始匹配
优先与上一帧或局部参考关键帧建立匹配关系，快速给出初值。

#### 运动模型与先验信息
结合上一帧位姿与简单运动假设给出初始位姿预测，提高优化收敛速度。

#### 几何一致性约束
通过投影几何、尺度与观测可见性约束过滤错误匹配，稳健估计姿态。

#### 位姿优化
以重投影误差为目标的非线性优化，剔除外点后输出当前帧位姿与有效观测集合。

#### 关键帧判定
根据视差、观测覆盖率、跟踪质量等度量决定是否插入新关键帧，以维持地图密度与跟踪稳定性。

### 5.9 局部建图核心职责

#### 地图点生成与融合
利用新关键帧的视差与三角化生成新地图点，与邻接关键帧的重复点进行融合处理，抑制冗余。

#### 局部优化
对当前局部图（当前关键帧、共视关键帧、相关地图点）执行局部束调整，提升几何一致性。

#### 地图点筛除
依据可见率、匹配成功率与观测角度等指标剔除不稳定点，保持地图的"精而稳"特性。

### 5.10 回环检测与全局一致性优化

#### 回环候选检索
基于词袋模型在关键帧数据库中检索相似候选，初步评估相似度。

#### 回环验证
通过几何一致性与姿态关系验证候选，避免纯外观误差导致的误匹配。

#### 图优化
引入回环约束后执行位姿图优化与必要的全局束调整，整体抑制漂移并重塑一致坐标系。

### 5.11 地图对齐机制

#### 触发条件
当加载历史地图后，系统尝试将当前SLAM坐标系映射到该地图的坐标系。

#### 对齐输入
当前帧或短时间窗口内的观测与加载地图中的已知结构（关键帧/地图点）之间的对应关系。

#### 求解目标
估计一组刚性变换参数，使当前观测在加载地图坐标系下投影误差最小。

#### 使用方式

- 一旦对齐成功，渲染与点云显示均使用对齐后的相机位姿；
- 对齐失败时继续尝试，直至满足置信度阈值。

### 5.12 平面检测算法

#### 输入来源
来自当前位姿附近的稀疏地图点及其空间分布。

#### 模型假设
存在一个局部近似平面可解释一批点的空间位置。

#### 估计过程
通过稳健估计方法在三维点集中拟合最大一致集合的平面，并计算法向量与参考点。

#### 稳定策略
当地图发生显著变化或跟踪状态波动时，延迟或重复估计以获得更稳定的平面参数。

### 5.13 AR矩阵计算与一致性保障

#### 模型矩阵
将"物体局部坐标"变换到"平面/世界坐标"，体现位置、朝向与缩放关系。

#### 视图矩阵
将"世界坐标"转换到"相机坐标"，由当前相机位姿（优先使用对齐后的位姿）确定。

#### 投影矩阵
将"相机坐标"投影到"屏幕坐标"，由内参与视口参数构建，要求与处理分辨率保持一致关系。

#### 一致性要点
点云、AR物体与相机画面必须基于同一坐标变换链路，任何一步坐标系选择不一致都会引起错位。

### 5.14 YOLO异步处理机制

#### 生产者-消费者模型
渲染/SLAM线程按节奏提交降采样图像；检测线程在有新任务时唤醒执行推理。

#### 同步与共享机制
使用信号量/条件变量避免忙等；共享检测结果并加时间戳，渲染端按需取用。

#### 结果稳定性保障
没有新结果时沿用旧结果，避免检测框闪烁；必要时可设定结果过期策略来平衡时效。

#### 资源控制策略
在设备能力不足时禁用检测功能，或适当降低输入尺寸与检测频率，减少对SLAM的干扰。

### 5.15 系统失败处理与恢复机制

#### 短时跟踪失败
通过运动模型和局部匹配尝试快速恢复；若恢复失败，进入"丢失"状态计时。

#### 丢失超时处理
执行"轻量重置"，仅清理跟踪状态而保留地图，随后继续尝试基于已加载地图进行重定位。

#### 对齐不稳定处理
当对齐置信度不足时，暂不采用对齐位姿用于AR渲染，避免视觉错位；继续积累观测直至满足阈值。

#### 平面不稳定处理
在地图明显更新或观测不足时暂缓平面更新，待状态稳定后再刷新AR模型矩阵。

## 6. 系统可靠性与容错设计

### 丢失恢复机制
当系统长时间处于丢失状态时，执行"轻量重置"操作，仅清理跟踪状态但保留已加载地图，以便更快恢复。

### 平面一致性保障

- 对于"从地图恢复的平面"，严格依赖地图对齐；
- 对于"现场检测的平面"，在未对齐前也可使用，但不会影响已对齐逻辑。

### 地图安全保障
对加载的地图规模进行合理边界检查，规避内存压力或系统不稳定。

### 渲染容错机制
当系统状态或矩阵不满足要求时不绘制AR物体，避免闪屏与错位现象。

### 重置细节处理
执行"轻量重置"时保留已加载地图与从地图恢复的平面，仅清理手动检测的平面与临时AR状态，以减少视觉突变。

## 7. 系统配置与资源管理

### 资源内嵌机制
相机配置、词袋、检测模型等以二进制形式打包进本地库，运行时经内存映射读取，避免路径与权限问题。

### 相机内参配置
用于投影矩阵推导，需与图像处理分辨率关系保持一致。

### 数字水印功能
通过开关控制是否叠加，支持按画面大小自适应缩放与透明合成。

## 8. 系统使用边界与前置条件

### 光照、纹理与运动条件
良好的纹理与稳定的相机运动能显著提升跟踪稳定性；过度运动模糊或重复纹理会降低效果。

### 设备性能要求
内存、CPU核心数、图形能力与系统版本会显著影响实时性与是否启用可选功能（如目标检测）。

### 数据安全要求
持久化地图与附属信息属于本地文件，需遵循平台权限与用户数据安全要求。

## 9. 术语解释

- **位姿**：相机在空间中的位置与朝向。
- **关键帧**：在时间序列中被挑选出来、具有代表性的帧，用于地图构建与优化。
- **地图点**：三维空间中的稀疏特征点集合。
- **对齐**：将当前SLAM坐标系与加载地图的坐标系建立稳定的一致关系。
- **投影矩阵**：由相机内参与视口参数计算，用于将三维点变换到屏幕平面。

## 10. 结论

Vtonax_SLAM系统在移动端整合了单目SLAM、平面检测、AR渲染与可选的目标检测功能。通过明确的渲染条件与对齐策略、资源内嵌与线程并行机制，以及轻量重置与参考缓存重建等可靠性设计，本系统在普通移动设备上取得了良好的实时性与稳定性平衡，适用于AR放置、室内可视化定位与轻量感知融合等应用场景。

## 13. 数学与优化要点

### 13.1 相机模型与投影变换

#### 相机内参矩阵
包含焦距(fx, fy)和主点(cx, cy)参数，用于将三维空间点投影到二维像素坐标。

#### 世界坐标系到相机坐标系的变换
通过旋转矩阵R和平移向量t将世界点Xw转换为相机坐标Xc。

#### 投影过程
先将相机坐标归一化(Xc/Zc, Yc/Zc)，再通过内参矩阵映射到像素坐标系。

#### 单目尺度不确定性
由于单目相机缺乏深度信息，需要通过关键帧图优化和闭环检测来解决尺度漂移问题。

### 13.2 重投影误差与鲁棒优化

#### 重投影残差计算
观测值与预测投影值之间的差异，用于衡量位姿估计的准确性。

#### 优化目标函数
最小化所有观测点的重投影误差加权和，使用鲁棒损失函数减少异常值影响。

#### 位姿优化方法

- **PNP算法**：在已知三维点和对应二维投影的情况下求解相机位姿
- **LM算法**：采用阻尼策略提高非线性优化的稳定性
- **BA优化**：同时优化相机位姿和三维点坐标以获得全局最优解

### 13.3 关键帧插入与局部束调整

#### 关键帧插入准则

- **视差阈值**：当前帧与参考关键帧之间应有足够的视差
- **覆盖率**：新帧应观测到足够多的局部地图点
- **跟踪内点率**：跟踪质量需满足最低要求

#### 局部束调整(局部BA)

- **优化范围**：当前关键帧、共视关键帧及相关地图点构成的子图
- **优化目标**：最小化子图内所有重投影误差
- **求解策略**：采用稀疏增量求解方法平衡计算效率与精度

### 13.4 闭环检测与位姿图优化

#### 闭环检测流程

- **候选检索**：基于词袋模型在关键帧数据库中查找相似关键帧
- **几何验证**：通过几何一致性检查确认真正的闭环关系
- **约束添加**：将闭环约束添加到位姿图结构中

#### 位姿图优化

- **优化目标**：最小化所有位姿间相对变换的误差
- **信息矩阵**：表示各边测量的置信度
- **优化后处理**：可附加全局BA进一步优化地图质量

### 13.5 跨会话地图对齐

#### 对齐触发条件
加载历史地图后，需要将当前SLAM坐标系与加载地图坐标系对齐。

#### 对齐算法原理

- **输入数据**：当前观测与加载地图中已知结构的对应关系
- **优化目标**：寻找最优相似变换，使对应点在目标坐标系下的投影误差最小
- **求解方法**：采用正交Procrustes问题或Umeyama算法求解，包含旋转、平移和尺度变换

#### 对齐结果应用

- **成功对齐后**，渲染和点云显示均使用对齐后的坐标系
- **对齐失败时**继续尝试，直至满足置信度阈值

### 13.6 平面估计方法

#### 平面表示方法
使用法向量n和平面到原点距离d表示平面，满足约束条件||n||=1。

#### 平面拟合算法

- **RANSAC算法**：通过随机采样最小点集估计平面模型
- **内点选择**：根据正交距离阈值筛选符合平面模型的点
- **优化过程**：对内点集最小化正交距离平方和以获得最优平面参数

#### 平面参数计算

- **法向量计算**：通过对协方差矩阵进行特征分解，法向量对应最小特征值的特征向量
- **距离计算**：通过法向量和平面中心点计算平面到原点的距离

### 13.7 投影/视图/模型矩阵与坐标系变换

#### 模型矩阵
描述物体局部坐标到世界坐标的变换，包括旋转、平移和缩放。

#### 视图矩阵
将世界坐标转换为相机坐标，基于当前相机位姿计算。

#### 投影矩阵
将相机坐标映射到屏幕坐标，根据相机内参和视口参数构建。

#### 坐标一致性要求
点云显示、AR物体渲染和相机画面必须使用相同的坐标变换链路，确保视觉一致性。

### 13.8 目标检测的多线程推理建模

#### 检测函数模型
将输入图像映射到目标集合（类别、置信度、边界框）。

#### 多线程架构

- **生产者**：渲染/SLAM线程按固定节拍提交降采样图像
- **消费者**：检测线程在有新任务时进行推理计算
- **同步机制**：使用信号量和条件变量避免忙等，确保线程间高效协作

#### 结果处理策略

- **稳定性保障**：无新结果时沿用上次检测结果，避免检测框闪烁
- **尺度映射**：将检测结果从降采样图像尺度映射回原始图像尺度

### 13.9 系统失效与恢复机制

#### 状态定义
系统包含未初始化、跟踪正常和丢失三种状态。

#### 恢复机制

- **短时失败**：通过运动模型和局部匹配尝试快速恢复
- **长时丢失**：超过阈值时间后执行轻量重置，仅清理跟踪状态保留地图
- **重定位**：基于已加载地图进行重新定位匹配

### 13.10 李群参数化与增量更新

#### 位姿参数化
采用李群SE(3)或相似变换群Sim(3)表示相机位姿。

#### 优化过程

- **李代数表示**：在李代数空间进行优化计算
- **指数映射**：通过指数映射将李代数增量更新到位姿

#### 线性化处理

- **残差近似**：通过一阶泰勒展开近似残差函数
- **正规方程**：根据线性化结果构建并求解正规方程

### 13.11 正规方程与Schur消元法

#### 加权最小二乘
构建加权正规方程处理不同观测的置信度差异。

#### Schur消元法

- **矩阵分块**：将Hessian矩阵分为位姿和结构两部分
- **消元过程**：对结构变量进行消元以降低系统维度
- **求解顺序**：先求解位姿增量，再回代求解结构增量

#### 优化效果
显著减少线性系统规模，提高求解效率。

### 13.12 鲁棒M估计与核函数

#### 鲁棒损失函数

- **权重函数**：通过权重函数实现鲁棒损失，降低异常值影响
- **Huber核函数**：小残差采用二次增长，大残差采用线性增长

#### 迭代重加权

- **IRLS算法**：在每次迭代中根据当前残差更新权重矩阵
- **收敛性**：重复迭代直到优化问题收敛

### 13.13 RANSAC内点集与稳健几何估计

#### RANSAC算法流程

- **随机采样**：随机选择最小点集估计几何模型
- **内点评估**：通过代价函数评估所有点的内点属性
- **模型选择**：选择内点数最多或代价最小的模型

#### 精细化优化

- **加权优化**：对筛选出的内点集进行加权精细化优化
- **精度保障**：兼顾算法鲁棒性和估计精度

### 13.14 相似变换(Sim(3))闭式估计

#### 优化目标
寻找最优相似变换(包含旋转、平移和尺度)使对应点对误差最小。

#### 求解过程

- **去均值处理**：对点集进行去均值预处理
- **协方差计算**：计算点集间的协方差矩阵
- **SVD分解**：通过奇异值分解求解最优旋转矩阵
- **参数计算**：依次计算尺度因子和平移向量

#### 退化处理
对共线或共面等退化情况检查条件数和秩以确保求解稳定性。

### 13.15 约束条件、Gauge处理与边界处理

#### 单目系统约束

- **规约自由度**：单目SLAM存在尺度和整体位姿的规约自由度
- **约束方法**：通过固定首帧或添加先验约束消除零空间

#### 地图对齐处理

- **坐标锚定**：地图加载对齐后以目标坐标系为锚维持一致性
- **图优化**：在图优化中对锚节点施加强先验或固定处理

### 13.16 数值稳定性与收敛性分析

#### 稳定性策略

- **阻尼方法**：采用LM等阻尼策略提高高非线性区域的稳定性
- **初值选择**：利用运动模型或局部匹配提供良好初值以加速收敛

#### 退化识别

- **监测指标**：检查Hessian矩阵条件数、特征值谱和内点比例
- **自适应调整**：根据监测结果推迟关键帧插入或调整优化参数
